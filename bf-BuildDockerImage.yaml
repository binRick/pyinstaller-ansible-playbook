x-reference-data:
  env: &env
      DOCKER_XYZ: abc123

  vars: &vars
      DOCKER_FILE: unknown

  distros: &distros
      -
        - fedora33
        - fedora34
        - fedora35
      -
        - alpine315
      -
        - debian10
        - debian11
      -
        - ubuntu20
        - ubuntu21
      -
        - centos7
        - centos8

  distro-vars: &distro-vars
      fedora33: { DOCKER_FILE: Dockerfile.fedora33, DOCKER_IMAGE: 'fedora:33' }
      fedora34: { DOCKER_FILE: Dockerfile.fedora34, DOCKER_IMAGE: 'fedora:34' }
      fedora35: { DOCKER_FILE: Dockerfile.fedora35, DOCKER_IMAGE: 'fedora:35' }

      ubuntu20: { DOCKER_FILE: Dockerfile.ubuntu20, DOCKER_IMAGE: 'ubuntu:20.04' }
      ubuntu21: { DOCKER_FILE: Dockerfile.ubuntu21, DOCKER_IMAGE: 'ubuntu:20.10' }

      alpine315: { DOCKER_FILE: Dockerfile.alpine315, DOCKER_IMAGE: 'alpine:3.15' }

      debian10: { DOCKER_FILE: Dockerfile.debian10, DOCKER_IMAGE: 'debian:10' }
      debian11: { DOCKER_FILE: Dockerfile.debian11, DOCKER_IMAGE: 'debian:11' }

      centos7: { DOCKER_FILE: Dockerfile.centos7, DOCKER_IMAGE: 'centos:7' }
      centos8: { DOCKER_FILE: Dockerfile.centos8, DOCKER_IMAGE: 'centos:8' }
      '*':
        DOCKER_PATH: .
        DOCKER_MODE: build
        DOCKER_LABEL: ansible
        ANSIBLE_PATH: /compile/dist/ansible
        ANSIBLE_PLAYBOOK_PATH: /compile/dist/ansible-playbook
        ANSIBLE_DEST: ./binaries
        DOCKER_HUB: docker.io

config:
  replica-replace-pattern: '%'
  max-parallel-commands: 10
  show-failure-report: yes
  ignore-failure: no
  vars: *vars
  show-task-times: yes
  log-path: /tmp/ansible-docker-images.log
tasks:
  - name: Build Docker Images
    tags: [build]
    parallel-tasks:
    - name: Build Docker Image %
      stdout-log: /tmp/ansible-docker-image-%-stdout.log
      stderr-log: /tmp/ansible-docker-image-%-stderr.log
      for-each-list: *distros
      apply-each-vars: *distro-vars
      env: *env
      vars:
        SPECIFIED_DISTRO: centos7

      pre-cmd: eval "command docker pull {{DOCKER_HUB}}/{{DOCKER_IMAGE}}"
      cmd: eval "command docker build --target=%-{{DOCKER_LABEL}} --tag=%-{{DOCKER_LABEL}} --file={{DOCKER_FILE}} --label={{DOCKER_LABEL}} --pull=false {{DOCKER_PATH}}"
      post-cmd: |
        [[ -d "{{ANSIBLE_DEST}}/%" ]] || mkdir -p "{{ANSIBLE_DEST}}/%"
        cid=$(command docker create %-{{DOCKER_LABEL}})
        cmd="command docker cp $cid:{{ANSIBLE_PATH}} {{ANSIBLE_DEST}}/%/."
        cmd="$cmd && command docker cp $cid:{{ANSIBLE_PLAYBOOK_PATH}} {{ANSIBLE_DEST}}/%/."
        echo -e "cid=$cid|cmd=$cmd"
        eval "$cmd"
        eval {{ANSIBLE_DEST}}/%/ansible --version
        eval {{ANSIBLE_DEST}}/%/ansible-playbook --version
        >&2 echo % OK- {{ANSIBLE_DEST}}/%/ansible {{ANSIBLE_DEST}}/%/ansible-playbook
      when:
        - "{{ITEM}} == {{ITEM}}"
#        - "{{ITEM}} == {{SPECIFIED_DISTRO}}"

